name: Bump dependency versions

on:
  workflow_dispatch:
    inputs:
      sui_tag:
        description: >
          Sui testnet release tag (e.g. testnet-v1.66.0).
          Leave empty to auto-detect the latest release.
        required: false
        type: string
      walrus_ref:
        description: >
          Walrus git ref (40-char SHA, branch, or tag).
          Leave empty to skip Walrus bump.
        required: false
        type: string
  repository_dispatch:
    types: [bump-dependencies]

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    name: Bump versions and create PR
    runs-on: ubuntu-ghcloud
    outputs:
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
      sui_tag: ${{ steps.inputs.outputs.sui_tag }}
      walrus_ref: ${{ steps.inputs.outputs.walrus_ref }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Resolve inputs
        id: inputs
        env:
          INPUT_SUI_TAG: ${{ inputs.sui_tag || github.event.client_payload.sui_tag || '' }}
          INPUT_WALRUS_REF: ${{ inputs.walrus_ref || github.event.client_payload.walrus_ref || '' }}
          GH_TOKEN: ${{ github.token }}
        run: |
          SUI_TAG="$INPUT_SUI_TAG"
          WALRUS_REF="$INPUT_WALRUS_REF"

          # Auto-detect latest Sui tag if not provided and no walrus-only bump.
          if [[ -z "$SUI_TAG" && -z "$WALRUS_REF" ]]; then
            echo "No inputs provided, auto-detecting latest Sui testnet release ..."
            SUI_TAG=$(gh release list --repo MystenLabs/sui --limit 50 \
              | awk '{print $1}' \
              | grep -E '^testnet-v[0-9]+\.[0-9]+\.[0-9]+$' \
              | head -1)
            if [[ -z "$SUI_TAG" ]]; then
              echo "Error: could not determine latest Sui testnet release"
              exit 1
            fi
            echo "Resolved latest Sui tag: $SUI_TAG"
          fi

          echo "sui_tag=$SUI_TAG" >> "$GITHUB_OUTPUT"
          echo "walrus_ref=$WALRUS_REF" >> "$GITHUB_OUTPUT"

      - name: Install Sui via suiup
        env:
          SUI_TAG: ${{ steps.inputs.outputs.sui_tag }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Install suiup itself.
          curl -sSfL https://raw.githubusercontent.com/MystenLabs/suiup/main/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.local/bin:$PATH"

          # Determine which Sui version to install.
          # Use provided tag, or auto-detect from the repo's current pinned version.
          TAG="$SUI_TAG"
          if [[ -z "$TAG" ]]; then
            TAG=$(grep -oP 'tag = "\Ktestnet-v[0-9]+\.[0-9]+\.[0-9]+' site-builder/Cargo.toml | head -1)
            echo "No Sui tag provided, using current pinned version: $TAG"
          fi
          suiup install "sui@${TAG}" -y

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2.8.0

      - name: Run bump script
        env:
          SUI_TAG: ${{ steps.inputs.outputs.sui_tag }}
          WALRUS_REF: ${{ steps.inputs.outputs.walrus_ref }}
        run: |
          ARGS=()
          [[ -n "$SUI_TAG" ]] && ARGS+=(--sui-tag "$SUI_TAG")
          [[ -n "$WALRUS_REF" ]] && ARGS+=(--walrus-ref "$WALRUS_REF")
          ./scripts/bump_versions.sh "${ARGS[@]}"

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet; then
            echo "No changes detected — already up to date."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR
        id: create-pr
        if: steps.diff.outputs.has_changes == 'true'
        env:
          SUI_TAG: ${{ steps.inputs.outputs.sui_tag }}
          WALRUS_REF: ${{ steps.inputs.outputs.walrus_ref }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Build dynamic branch name, title, and body.
          PARTS=()
          TITLE_PARTS=()
          BODY_LINES=()

          if [[ -n "$SUI_TAG" ]]; then
            PARTS+=("sui-${SUI_TAG}")
            TITLE_PARTS+=("Sui to ${SUI_TAG}")
            BODY_LINES+=("- \`site-builder/Cargo.toml\` — Sui git tag references")
          fi

          if [[ -n "$WALRUS_REF" ]]; then
            SHORT_REF="${WALRUS_REF:0:8}"
            PARTS+=("walrus-${SHORT_REF}")
            TITLE_PARTS+=("Walrus to ${SHORT_REF}")
            BODY_LINES+=("- \`site-builder/Cargo.toml\` — Walrus rev references")
          fi

          BODY_LINES+=("- \`Cargo.lock\` — regenerated")
          BODY_LINES+=("- \`move/**/Move.lock\` — regenerated")

          BRANCH="bump-$(IFS=-; echo "${PARTS[*]}")-$(date +%s)"
          TITLE="chore: bump $(IFS=', '; echo "${TITLE_PARTS[*]}")"
          BODY="## Summary

          Automated dependency version bump.

          **Files updated:**
          $(printf '%s\n' "${BODY_LINES[@]}")

          ## Test plan

          - [ ] CI passes (Rust build, clippy, tests)
          - [ ] Move tests pass"

          git checkout -b "$BRANCH"
          git add -u . ':!.github/workflows'
          git -c user.name="github-actions[bot]" \
              -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
              commit -m "$TITLE"
          git push origin "$BRANCH"
          PR_URL=$(gh pr create --title "$TITLE" --body "$BODY")
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          gh pr merge --auto --squash

  notify:
    name: Notify via Slack
    needs: bump
    if: success() && needs.bump.outputs.pr_url != ''
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch to sui-operations
        uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697 # v4.0.1
        with:
          token: ${{ secrets.SUI_OPS_DISPATCH_TOKEN }}
          repository: MystenLabs/sui-operations
          event-type: walrus-sites-version-bump-notify
          client-payload: >-
            {
              "pr_url": "${{ needs.bump.outputs.pr_url }}",
              "sui_tag": "${{ needs.bump.outputs.sui_tag }}",
              "walrus_ref": "${{ needs.bump.outputs.walrus_ref }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "run_id": "${{ github.run_id }}"
            }
