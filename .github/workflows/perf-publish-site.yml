name: "Perf: Publish Site"

# Reusable workflow to publish built sites to Walrus Sites using site-builder CLI.
# Downloads build artifacts, sets up sui/walrus toolchain, and deploys sequentially.

on:
  workflow_call:
    inputs:
      ref:
        description: "Git ref (branch, tag, or commit SHA) of walrus-sites to test"
        required: false
        type: string
        default: ""
      test_sites:
        description: "Which sites to publish (all, walrus-docs, seal-docs, stake-wal, landing-page)"
        required: true
        type: string
    secrets:
      SUI_KEYSTORE_TESTNET:
        required: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish Sites
    runs-on: ubuntu-ghcloud
    steps:
      - name: Checkout walrus-sites repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Install suiup, sui, and walrus
        run: |
          curl -sSfL https://raw.githubusercontent.com/MystenLabs/suiup/main/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"
          suiup install sui -y
          suiup install walrus -y

      - name: Setup Sui wallet from keystore
        run: |
          mkdir -p ~/.sui/sui_config
          echo '${{ secrets.SUI_KEYSTORE_TESTNET }}' > ~/.sui/sui_config/sui.keystore
          cat > ~/.sui/sui_config/client.yaml << EOF
          keystore:
            File: $HOME/.sui/sui_config/sui.keystore
          envs:
            - alias: testnet
              rpc: "https://fullnode.testnet.sui.io:443"
              ws: ~
          active_env: testnet
          active_address: "${{ vars.SUI_ADDRESS_TESTNET }}"
          EOF

      - name: Setup Walrus config
        run: |
          mkdir -p ~/.config/walrus
          curl -sSL https://raw.githubusercontent.com/MystenLabs/walrus/main/setup/client_config.yaml \
            -o ~/.config/walrus/client_config.yaml

      - name: Verify wallet setup
        run: |
          sui client active-address
          sui client balance

      - uses: Swatinem/rust-cache@98c8021b550208e191a6a3145459bfc9fb29c4c0 # v2.8.0

      - name: Build site-builder
        run: cargo build --release -p site-builder

      # --- Sequential publish steps with cost tracking ---

      - name: Download walrus-docs artifact
        if: ${{ inputs.test_sites == 'all' || inputs.test_sites == 'walrus-docs' }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: walrus-docs-build
          path: walrus-docs-site

      - name: Deploy walrus-docs
        if: ${{ inputs.test_sites == 'all' || inputs.test_sites == 'walrus-docs' }}
        id: deploy_walrus_docs
        run: ./scripts/deploy_with_cost.sh --site-name walrus_docs --site-dir ./walrus-docs-site

      - name: Download seal-docs artifact
        if: ${{ inputs.test_sites == 'all' || inputs.test_sites == 'seal-docs' }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: seal-docs-build
          path: seal-docs-site

      - name: Deploy seal-docs
        if: ${{ inputs.test_sites == 'all' || inputs.test_sites == 'seal-docs' }}
        id: deploy_seal_docs
        run: ./scripts/deploy_with_cost.sh --site-name seal_docs --site-dir ./seal-docs-site

      - name: Download stake-wal artifact
        if: ${{ inputs.test_sites == 'all' || inputs.test_sites == 'stake-wal' }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: stake-wal-build
          path: stake-wal-site

      - name: Deploy stake-wal
        if: ${{ inputs.test_sites == 'all' || inputs.test_sites == 'stake-wal' }}
        id: deploy_stake_wal
        run: ./scripts/deploy_with_cost.sh --site-name stake_wal --site-dir ./stake-wal-site

      - name: Download landing-page artifact
        if: ${{ inputs.test_sites == 'all' || inputs.test_sites == 'landing-page' }}
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: landing-page-build
          path: landing-page-site

      - name: Deploy landing-page
        if: ${{ inputs.test_sites == 'all' || inputs.test_sites == 'landing-page' }}
        id: deploy_landing_page
        run: ./scripts/deploy_with_cost.sh --site-name landing_page --site-dir ./landing-page-site

      # --- Cost Summary ---
      - name: Generate cost summary
        if: ${{ always() }}
        run: |
          echo "## Deploy Cost Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Site | Time (s) | SUI Cost | WAL Cost |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|----------|----------|" >> $GITHUB_STEP_SUMMARY

          [ -n "${{ steps.deploy_walrus_docs.outputs.walrus_docs_sui_cost_human }}" ] && \
            echo "| walrus-docs | ${{ steps.deploy_walrus_docs.outputs.walrus_docs_deploy_time }} | ${{ steps.deploy_walrus_docs.outputs.walrus_docs_sui_cost_human }} SUI | ${{ steps.deploy_walrus_docs.outputs.walrus_docs_wal_cost_human }} WAL |" >> $GITHUB_STEP_SUMMARY

          [ -n "${{ steps.deploy_seal_docs.outputs.seal_docs_sui_cost_human }}" ] && \
            echo "| seal-docs | ${{ steps.deploy_seal_docs.outputs.seal_docs_deploy_time }} | ${{ steps.deploy_seal_docs.outputs.seal_docs_sui_cost_human }} SUI | ${{ steps.deploy_seal_docs.outputs.seal_docs_wal_cost_human }} WAL |" >> $GITHUB_STEP_SUMMARY

          [ -n "${{ steps.deploy_stake_wal.outputs.stake_wal_sui_cost_human }}" ] && \
            echo "| stake-wal | ${{ steps.deploy_stake_wal.outputs.stake_wal_deploy_time }} | ${{ steps.deploy_stake_wal.outputs.stake_wal_sui_cost_human }} SUI | ${{ steps.deploy_stake_wal.outputs.stake_wal_wal_cost_human }} WAL |" >> $GITHUB_STEP_SUMMARY

          [ -n "${{ steps.deploy_landing_page.outputs.landing_page_sui_cost_human }}" ] && \
            echo "| landing-page | ${{ steps.deploy_landing_page.outputs.landing_page_deploy_time }} | ${{ steps.deploy_landing_page.outputs.landing_page_sui_cost_human }} SUI | ${{ steps.deploy_landing_page.outputs.landing_page_wal_cost_human }} WAL |" >> $GITHUB_STEP_SUMMARY

      # --- Cleanup: Destroy deployed sites ---
      - name: Destroy walrus-docs site
        if: ${{ always() && steps.deploy_walrus_docs.outputs.walrus_docs_site_id }}
        run: ./target/release/site-builder --context testnet destroy ${{ steps.deploy_walrus_docs.outputs.walrus_docs_site_id }}

      - name: Destroy seal-docs site
        if: ${{ always() && steps.deploy_seal_docs.outputs.seal_docs_site_id }}
        run: ./target/release/site-builder --context testnet destroy ${{ steps.deploy_seal_docs.outputs.seal_docs_site_id }}

      - name: Destroy stake-wal site
        if: ${{ always() && steps.deploy_stake_wal.outputs.stake_wal_site_id }}
        run: ./target/release/site-builder --context testnet destroy ${{ steps.deploy_stake_wal.outputs.stake_wal_site_id }}

      - name: Destroy landing-page site
        if: ${{ always() && steps.deploy_landing_page.outputs.landing_page_site_id }}
        run: ./target/release/site-builder --context testnet destroy ${{ steps.deploy_landing_page.outputs.landing_page_site_id }}
